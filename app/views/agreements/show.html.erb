<%# Agreements#show %>
<% content_for :title, @agreement.title %>

<div class="bg-zinc-100 min-h-screen">
  <section class="container mx-auto px-4 py-10">
    <div class="w-full max-w-3xl mx-auto">
      <div class="bg-white rounded-2xl p-6">
        <div class="flex items-center justify-between mb-4">
          <h1 class="text-2xl font-bold text-gray-800"><%= @agreement.title %></h1>
          <div class="flex items-center gap-2">
            <% if @acceptance.present? %>
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Complete</span>
              <%= link_to "Download PDF", download_agreement_path(@agreement.document_type, user_id: @subject_user&.id), class: "px-3 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
            <% else %>
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Outstanding</span>
            <% end %>
          </div>
        </div>

        <% if @acceptance.present? %>
          <% participant_email = (@subject_user || current_user).email %>
          <div class="mb-4 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <div class="text-sm text-gray-700">
              <div class="mb-1">Accepted by <strong><%= @acceptance.signed_name %></strong> on <%= @acceptance.signed_at.strftime('%-d %b %Y %H:%M %Z') %></div>
              <div class="mb-1"><span class="font-medium">Signed Participant Email:</span> <%= participant_email %></div>
              <div class="mb-1"><span class="font-medium">IP:</span> <%= @acceptance.ip_address %></div>
              <div class="mb-1 break-words"><span class="font-medium">User-Agent:</span> <%= @acceptance.user_agent %></div>
              <div class="mb-1 break-all"><span class="font-medium">Content Hash:</span> <%= @acceptance.content_hash %></div>
              <div class="mb-1"><span class="font-medium">Agreement Created:</span> <%= @acceptance.created_at.strftime('%-d %b %Y %H:%M %Z') %></div>
              <div class=""><span class="font-medium">Email:</span> ak@qcare.au</div>
            </div>
          </div>
        <% end %>

        <article class="prose max-w-none">
          <div class="text-gray-800">
            <%= render_agreement_html(@agreement, user: (@subject_user || current_user), acceptance: @acceptance, location: @location) %>
          </div>
        </article>

        <% if @acceptance.blank? && ((@subject_user || current_user) == current_user) %>
          <hr class="my-6" />
          <div x-data="{ signedName: '' }">
          <%= form_with url: accept_agreement_path(@agreement.document_type), method: :post, local: true do |f| %>
            <div class="mb-4">
              <label for="agreement_signed_name" class="mt-4 block text-sm font-medium text-gray-700">Signed</label>
              <input x-model="signedName" type="text" name="agreement[signed_name]" id="agreement_signed_name" placeholder="Type your legal name to sign." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm placeholder:text-gray-400 px-4 py-3 text-lg" required>
            </div>
            <div class="mb-6">
              <div class="text-xs uppercase tracking-wide text-gray-500">Signature preview</div>
              <div class="mt-2 text-3xl" style="font-family: 'Mr Dafoe', cursive"><span x-text="signedName || 'Your Name'"></span></div>
              <div class="mt-3 text-xs text-gray-600 space-y-1">
                <div>
                  <span class="font-medium text-gray-700">Date & time:</span>
                  <span><%= Time.current.strftime('%-d %b %Y %H:%M %Z') %></span>
                </div>
                <div>
                  <span class="font-medium text-gray-700">IP address:</span>
                  <span><%= request.remote_ip %></span>
                </div>
                <div>
                  <span class="font-medium text-gray-700">Content hash:</span>
                  <code class="text-gray-700"><%= @agreement.content_hash %></code>
                </div>
              </div>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-xs text-gray-500">By clicking Accept, you agree to the terms above.</p>
              <%= f.submit "Accept", class: "px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700" %>
            </div>
          <% end %>
          </div>
        <% elsif @acceptance.blank? %>
          <div class="mt-6 text-sm text-gray-600">This agreement is outstanding.</div>
        <% end %>
      </div>
    </div>
  </section>
  
</div>
