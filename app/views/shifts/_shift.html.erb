<%
  area = shift.area
  roster_is_draft = shift.roster.draft?
  show_location_name = selected_location_id.blank?
  # Base classes for the main container
  main_div_classes = "p-1 rounded-2xl relative flex flex-col justify-between"
  main_div_style = ""

  # Classes and styles for PUBLISHED shifts
  unless roster_is_draft
    main_div_style = "background-color: #{area.color};" if area&.color.present?
    main_div_classes += " #{area&.color.blank? ? 'bg-violet-500' : ''}"
    main_div_classes += (area&.color == '#ffffff') ? ' text-zinc-800' : ' text-white'
    
  end

  # Classes and styles for DRAFT shifts
  if roster_is_draft
    main_div_classes += "border-2 border-dashed bg-white"
    main_div_style = "border-color: #{area&.color || '#bc15cbff'};" # Fallback to gray border
    main_div_classes += " text-zinc-800" # Text is always dark for drafts
  end

  # Determine background for child elements based on roster status
  child_bg_class = roster_is_draft ? 'bg-black/10' : 'bg-black/10'
  edit_icon_bg_class = roster_is_draft ? 'bg-black/10 hover:bg-black/20' : 'bg-black/20 hover:bg-black/40'
  default_child_bg_class = roster_is_draft ? 'bg-gray-200' : 'bg-violet-700'
  default_edit_icon_bg_class = roster_is_draft ? 'bg-gray-200 hover:bg-gray-300' : 'bg-violet-600/50 hover:bg-violet-600/90'
%>

<%= turbo_frame_tag dom_id(shift), data: { id: shift.id }, target: "assign_shift_modal", class: "#{roster_is_draft ? 'drag-enabled' : 'drag-disabled'} relative group h-full" do %>
  <div style="<%= main_div_style %>" class="<%= main_div_classes %>">
    <% if local_assigns[:unavailability_overlap].present? %>
      <% range_text = display_range_or_allday(unavailability_overlap[:starts_at], unavailability_overlap[:ends_at]) %>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none">
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-red-100 text-red-500" title="<%= range_text %>">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
        </span>
      </div>
    <% end %>
    
    <div class="flex justify-between items-start">
      <div>
        <p class="text-sm font-bold ml-2"><%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></p>
      </div>
      <div class="flex items-center justify-between">
      <% duration_in_hours = (shift.end_time - shift.start_time) / 3600.0 %>
      <span class="<%= area&.color.present? ? child_bg_class : default_child_bg_class %> px-2 py-0.5 rounded-3xl text-xs font-semibold">
        <%= number_with_precision(duration_in_hours, precision: (duration_in_hours % 1 == 0 ? 0 : 1)) %>h
      </span>
    </div>
      
    </div>
    
    
    <div class="leading-none space-y-0">
      <p class="ml-2 text-xs font-light"><%= area&.name %></p>
      <div class="flex items-center justify-between ml-2">
        <% if shift.note.present? %>
          <p class="m-2 text-xs font-light italic"><%= shift.note %></p>
        <% else %>
          <p class="m-2 text-xs font-light italic invisible">&nbsp;</p>
        <% end %>
        <% if roster_is_draft %>
          <div class="opacity-0 group-hover:opacity-100 transition-opacity ml-2">
            <%= link_to edit_shift_path(shift, location_id: selected_location_id), data: { turbo_frame: "assign_shift_modal" } do %>
              <span class="inline-block p-1 rounded-full <%= area&.color.present? ? edit_icon_bg_class : default_edit_icon_bg_class %>">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
              </span>
            <% end %>
          </div>
        <% else %>
          <div class="ml-2 invisible">
            <span class="inline-block p-1 rounded-full <%= default_edit_icon_bg_class %>">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
            </span>
          </div>
        <% end %>
      </div>

      <% if show_location_name %>
        <p class="m-0 text-xs font-light ml-2"><%= shift.location&.name %></p>
      <% else %>
        <p class="m-0 text-xs font-light ml-2 invisible">&nbsp;</p>
      <% end %>
    </div>
  </div>
<% end %>