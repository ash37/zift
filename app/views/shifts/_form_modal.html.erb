<%= turbo_frame_tag "assign_shift_modal" do %>
  <div class="fixed inset-0 w-full h-full bg-black/50 z-10" data-controller="modal" data-action="click->modal#close">
    <div class="relative absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-lg p-6 w-full max-w-md" data-action="click->modal#stopClose" data-controller="dynamic-select" data-areas="<%= Area.excluding_travel.order(:name).to_json(only: [:id, :name, :location_id]) %>">

      <h2 class="text-xl font-bold mb-4"><%= @shift.persisted? ? "Edit Shift" : "New Shift" %></h2>

      <%= form_with(model: @shift) do |f| %>
        <%= f.hidden_field :roster_id %>
        <%= f.hidden_field :user_id %>
        <%= f.hidden_field :date, value: params[:date] || @shift.start_time.to_date %>
        <%= f.hidden_field :roster_filter_location_id, value: @selected_location_id %>

        <% if @shift.location_id.present? %>
          <% location = Location.find(@shift.location_id) %>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Client</label>
            <p class="mt-1 block w-full rounded-md border border-gray-200 bg-gray-50 px-3 py-2 shadow-sm text-sm text-gray-500"><%= location.name %></p>
            <%= f.hidden_field :location_id, value: location.id, data: { 'dynamic-select-target': 'source' } %>
          </div>
        <% else %>
          <div class="mb-4">
            <%= f.label :location_id, "Client", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.collection_select :location_id, Location.all, :id, :name, { prompt: "Select a client" }, { class: "block w-full rounded-md border-gray-300 shadow-sm", data: { action: "change->dynamic-select#updateTarget", 'dynamic-select-target': 'source' } } %>
          </div>
        <% end %>

        <div class="mb-4">
          <%= f.label :area_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
          <% if @shift.location_id.present? %>
            <% loc = Location.find(@shift.location_id) rescue nil %>
            <%= f.collection_select :area_id, (loc ? loc.areas.excluding_travel.order(:name) : []), :id, :name,
                  { prompt: "Select an Area", selected: @shift.area_id },
                  { class: "block w-full rounded-md border-gray-300 shadow-sm", data: { 'dynamic-select-target': 'target' } } %>
          <% else %>
            <%= f.collection_select :area_id, [], :id, :name, { prompt: "Select an Area" }, { class: "block w-full rounded-md border-gray-300 shadow-sm", data: { 'dynamic-select-target': 'target' } } %>
          <% end %>
        </div>
        
        <div class="mb-4">
          <%= f.label :note, class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :note, rows: 3, class: "block w-full rounded-md border-gray-300 shadow-sm" %>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <%= f.label :start_time, class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.time_field :start_time, class: "block w-full rounded-md border-gray-300 shadow-sm" %>
          </div>
          <div>
            <%= f.label :end_time, class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.time_field :end_time, class: "block w-full rounded-md border-gray-300 shadow-sm" %>
          </div>
        </div>

        <div class="flex justify-end items-center pt-4 gap-3">
          <button type="button" data-action="click->modal#close" class="px-4 py-2 rounded-3xl text-sm bg-gray-100 hover:bg-gray-200">Cancel</button>
          <%= f.submit "Save Shift", class: "bg-zinc-800 hover:bg-zinc-900 text-white px-4 py-2 rounded-3xl text-sm cursor-pointer" %>
        </div>
      <% end %>

      <% if @shift.persisted? %>
        <div class="absolute bottom-6 left-6">
          <%= button_to "Delete Shift", shift_path(@shift, roster_filter_location_id: @selected_location_id), method: :delete,
              class: "text-sm text-red-600 hover:text-red-800",
              form: { data: { turbo_confirm: 'Are you sure you want to delete this shift?' } } %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
