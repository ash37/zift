<% content_for :title, @user.name %>

<div class="bg-zinc-100 min-h-screen" data-controller="file-preview">
  <section class="container mx-auto px-4 py-10">
    <div class="w-full max-w-4xl mx-auto">

      <div class="bg-white rounded-2xl p-6 flex items-center justify-between">
        <div class="flex items-center min-w-0">
          <div class="text-left">
            <h1 class="text-2xl font-bold text-gray-800 truncate"><%= @user.name %></h1>
            <p class="text-gray-600 break-all sm:break-normal"><%= @user.email %></p>
            <p class="text-gray-600 break-all sm:break-normal"><%= @user.phone %></p>
          </div>
        </div>
        <div class="ml-4 flex items-center gap-3">
          <% if current_user&.admin? || current_user&.manager? %>
            <div x-data="{ open: false }" class="relative">
              <button @click="open = !open" @keydown.escape.window="open = false" class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200" aria-haspopup="true" :aria-expanded="open.toString()" title="Actions">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM12 13.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM12 20.25a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" />
                </svg>
              </button>
              <div x-cloak x-show="open" x-transition @click.outside="open = false" class="absolute right-0 mt-2 w-40 rounded-lg shadow-md bg-white focus:outline-none" style="display: none;">
                <div class="py-1">
                  <%= link_to "Edit", edit_user_path(@user), class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
                  <% if @user.respond_to?(:archived?) && @user.archived? %>
                    <%= button_to "Restore", restore_user_path(@user), method: :patch, class: "w-full text-left block px-4 py-2 text-sm text-green-700 hover:bg-green-50" %>
                  <% else %>
                    <%= button_to "Archive", archive_user_path(@user), method: :patch, data: { turbo_confirm: "Archive this user?" }, class: "w-full text-left block px-4 py-2 text-sm text-red-700 hover:bg-red-50" %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <%# Employment agreement link for employees %>
      <% if @user.employee? %>
        <% current_employment_agreement = Agreement.current_for('employment') %>
        <% acceptance = current_employment_agreement && AgreementAcceptance.find_by(user: @user, agreement: current_employment_agreement) %>
        <div class="mt-4 bg-white rounded-2xl p-4">
          <div class="<%= acceptance.present? ? '' : 'border-2 border-dashed text-orange-500 rounded-xl p-3' %>">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-gray-800 font-semibold">Employment Agreement</div>
                <% if acceptance.present? %>
                  <div class="text-sm text-green-600">Complete — signed <%= acceptance.signed_at.strftime('%-d %b %Y') %></div>
                <% else %>
                  <div class="text-sm text-orange-500">Outstanding — please review and accept</div>
                <% end %>
              </div>
              <% if current_employment_agreement.present? %>
                <%= link_to "View", agreement_path('employment', user_id: @user.id), class: "px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
              <% end %>
            </div>
          </div>

          <%# Required uploads %>

          <div class="mt-4 space-y-3">
            <div class="p-3 rounded-2xl <%= @user.ndis_screening_card.attached? ? 'bg-gray-50' : 'border-2 border-dashed text-orange-500' %>">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="font-semibold text-gray-800">NDIS screening card</div>
                  <div class="mt-1 text-sm <%= @user.ndis_screening_card.attached? ? 'text-green-600' : 'text-orange-500' %>">
                    <% if @user.ndis_screening_card.attached? %>
                      <% attached_at = @user.ndis_screening_card.attachment&.created_at %>
                      Complete — attached <%= attached_at&.strftime('%-d %b %Y') %>
                    <% else %>
                      Upload a photo of your NDIS screening card.
                    <% end %>
                  </div>
                  <% if @user.ndis_screening_card.attached? %>
                    <div class="mt-2 text-xs">
                      <a href="#"
                         class="text-gray-700 hover:underline"
                         data-action="click->file-preview#open"
                         data-file-preview-file-url="<%= rails_blob_path(@user.ndis_screening_card, disposition: 'inline') %>"
                         data-file-preview-download-url="<%= rails_blob_path(@user.ndis_screening_card, disposition: 'attachment') %>"
                         data-file-preview-file-name="<%= @user.ndis_screening_card.filename %>"
                         data-file-preview-file-type="<%= @user.ndis_screening_card.blob.content_type %>"
                         data-file-preview-remove-url="<%= remove_attachment_user_path(@user, name: :ndis_screening_card) %>">
                        <%= @user.ndis_screening_card.filename %>
                      </a>
                    </div>
                  <% end %>
                </div>
                <% if (current_user == @user || current_user&.admin?) && !@user.ndis_screening_card.attached? %>
                  <div>
                    <%= form_with model: @user, url: user_path(@user), method: :patch, html: { multipart: true }, local: true do |f| %>
                      <div class="flex items-center gap-2" data-controller="file-input">
                        <span class="text-xs text-gray-400" data-file-input-target="label">No file selected</span>
                        <label class="px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm cursor-pointer">
                          Choose file
                          <%= f.file_field :ndis_screening_card, direct_upload: false, class: "sr-only", data: { action: "change->file-input#update", file_input_target: "input" } %>
                        </label>
                        <%= f.submit "Upload", class: "px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm hidden", data: { file_input_target: "submit" } %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>

            <div class="mt-4 p-3 rounded-2xl <%= @user.ndis_orientation_certificate.attached? ? 'bg-gray-50' : 'border-2 border-dashed text-orange-500' %>">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="font-semibold text-gray-800">NDIS worker orientation certificate</div>
                  <div class="mt-1 text-sm <%= @user.ndis_orientation_certificate.attached? ? 'text-green-600' : 'text-orange-500' %>">
                    <% if @user.ndis_orientation_certificate.attached? %>
                      <% attached_at = @user.ndis_orientation_certificate.attachment&.created_at %>
                      Complete — attached <%= attached_at&.strftime('%-d %b %Y') %>
                    <% else %>
                      Upload your NDIS worker orientation certificate.
                    <% end %>
                  </div>
                  <% if @user.ndis_orientation_certificate.attached? %>
                    <div class="mt-2 text-xs">
                      <a href="#"
                         class="text-gray-700 hover:underline"
                         data-action="click->file-preview#open"
                         data-file-preview-file-url="<%= rails_blob_path(@user.ndis_orientation_certificate, disposition: 'inline') %>"
                         data-file-preview-download-url="<%= rails_blob_path(@user.ndis_orientation_certificate, disposition: 'attachment') %>"
                         data-file-preview-file-name="<%= @user.ndis_orientation_certificate.filename %>"
                         data-file-preview-file-type="<%= @user.ndis_orientation_certificate.blob.content_type %>"
                         data-file-preview-remove-url="<%= remove_attachment_user_path(@user, name: :ndis_orientation_certificate) %>">
                        <%= @user.ndis_orientation_certificate.filename %>
                      </a>
                    </div>
                  <% end %>
                </div>
                <% if (current_user == @user || current_user&.admin?) && !@user.ndis_orientation_certificate.attached? %>
                  <div>
                    <%= form_with model: @user, url: user_path(@user), method: :patch, html: { multipart: true }, local: true do |f| %>
                      <div class="flex items-center gap-2" data-controller="file-input">
                        <span class="text-xs text-gray-400" data-file-input-target="label">No file selected</span>
                        <label class="px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm cursor-pointer">
                          Choose file
                          <%= f.file_field :ndis_orientation_certificate, direct_upload: false, class: "sr-only", data: { action: "change->file-input#update", file_input_target: "input" } %>
                        </label>
                        <%= f.submit "Upload", class: "px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm hidden", data: { file_input_target: "submit" } %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>

            <div class="mt-4 p-3 rounded-2xl <%= @user.qcare_induction_certificate.attached? ? 'bg-gray-50' : 'border-2 border-dashed text-orange-500' %>">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="font-semibold text-gray-800">Qcare induction certificate</div>
                  <div class="mt-1 text-sm <%= @user.qcare_induction_certificate.attached? ? 'text-green-600' : 'text-orange-500' %>">
                    <% if @user.qcare_induction_certificate.attached? %>
                      <% attached_at = @user.qcare_induction_certificate.attachment&.created_at %>
                      Complete — attached <%= attached_at&.strftime('%-d %b %Y') %>
                    <% else %>
                      Upload your Qcare induction certificate.
                    <% end %>
                  </div>
                  <% if @user.qcare_induction_certificate.attached? %>
                    <div class="mt-2 text-xs">
                      <a href="#"
                         class="text-gray-700 hover:underline"
                         data-action="click->file-preview#open"
                         data-file-preview-file-url="<%= rails_blob_path(@user.qcare_induction_certificate, disposition: 'inline') %>"
                         data-file-preview-download-url="<%= rails_blob_path(@user.qcare_induction_certificate, disposition: 'attachment') %>"
                         data-file-preview-file-name="<%= @user.qcare_induction_certificate.filename %>"
                         data-file-preview-file-type="<%= @user.qcare_induction_certificate.blob.content_type %>"
                         data-file-preview-remove-url="<%= remove_attachment_user_path(@user, name: :qcare_induction_certificate) %>">
                        <%= @user.qcare_induction_certificate.filename %>
                      </a>
                    </div>
                  <% end %>
                </div>
                <% if (current_user == @user || current_user&.admin?) && !@user.qcare_induction_certificate.attached? %>
                  <div>
                    <%= form_with model: @user, url: user_path(@user), method: :patch, html: { multipart: true }, local: true do |f| %>
                      <div class="flex items-center gap-2" data-controller="file-input">
                        <span class="text-xs text-gray-400" data-file-input-target="label">No file selected</span>
                        <label class="px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm cursor-pointer">
                          Choose file
                          <%= f.file_field :qcare_induction_certificate, direct_upload: false, class: "sr-only", data: { action: "change->file-input#update", file_input_target: "input" } %>
                        </label>
                        <%= f.submit "Upload", class: "px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm hidden", data: { file_input_target: "submit" } %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
             <div class="mt-4 p-3 rounded-2xl <%= (@user.id_documents.attachments.size >= 2) ? 'bg-gray-50' : 'border-2 border-dashed text-orange-500' %>">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <div class="font-semibold text-gray-800">Two forms of ID</div>
                  <div class="mt-1 text-sm <%= @user.id_documents.attachments.size >= 2 ? 'text-green-600' : 'text-orange-500' %>">
                    <% if @user.id_documents.attachments.size >= 2 %>
                      <% last_attached_at = @user.id_documents.attachments.map(&:created_at).compact.max %>
                      Complete — attached <%= last_attached_at&.strftime('%-d %b %Y') %>
                    <% else %>
                      Upload two separate IDs (e.g. licence, passport, Medicare).
                    <% end %>
                  </div>
                  <% if @user.id_documents.attachments.any? %>
                    <ul class="mt-2 text-xs text-gray-700 list-none space-y-1">
                      <% @user.id_documents.each_with_index do |doc, idx| %>
                        <li>
                          <a href="#"
                             class="text-gray-700 hover:underline"
                             data-action="click->file-preview#open"
                             data-file-preview-file-url="<%= rails_blob_path(doc, disposition: 'inline') %>"
                             data-file-preview-download-url="<%= rails_blob_path(doc, disposition: 'attachment') %>"
                             data-file-preview-file-name="<%= (doc.filename.presence || "ID Document ##{idx+1}") %>"
                             data-file-preview-file-type="<%= doc.content_type %>"
                             data-file-preview-remove-url="<%= remove_id_document_user_path(@user, signed_id: doc.blob.signed_id) %>">
                            <%= (doc.filename.presence || "ID Document ##{idx+1}") %>
                          </a>
                        </li>
                      <% end %>
                    </ul>
                  <% end %>
                </div>
                <% if (current_user == @user || current_user&.admin?) && (@user.id_documents.attachments.size < 2) %>
                  <div>
                    <%= form_with model: @user, url: user_path(@user), method: :patch, html: { multipart: true }, local: true do |f| %>
                      <div class="flex items-center gap-2" data-controller="file-input">
                        <span class="text-xs text-gray-400" data-file-input-target="label">No file selected</span>
                        <label class="px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm cursor-pointer">
                          Choose files
                          <%= f.file_field :id_documents, multiple: true, direct_upload: false, class: "sr-only", name: "user[id_documents][]", data: { action: "change->file-input#update", file_input_target: "input" } %>
                        </label>
                        <%= f.submit (@user.id_documents.attachments.any? ? "Add" : "Upload"), class: "px-3 py-1 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm hidden", data: { file_input_target: "submit" } %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>

          </div>
        </div>
      <% end %>

      <% if @user.locations.any? %>
        <div class="mt-4 bg-white rounded-3xl p-6 sm:p-8">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Clients</h2>
          <div class="flex flex-wrap gap-2">
            <% @user.locations.each do |location| %>
              <span class="inline-flex items-center rounded-3xl px-3 py-1 text-sm font-medium bg-violet-100 text-violet-700">
                <%= location.name %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>

<% if [User::STATUSES[:applicant], User::STATUSES[:contacted]].include?(@user.status) %>
        <%= render 'users/applicant_details', user: @user %>
     <% elsif @user.role == 'employee' %>
        <%= render 'users/employee_details', user: @user %>
     <% elsif (current_user&.respond_to?(:admin?) ? current_user.admin? : current_user&.role == 'admin') %>
        <%= render 'users/employee_admin_details', user: @user %>
     <% end %>

      <% unless @user.status == User::STATUSES[:applicant] %>
      <div class="mt-8">
        <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center justify-between">
          Upcoming Shifts
          <a href="#upcoming-shifts" onclick="document.getElementById('upcoming-shifts').classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180'); return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 text-gray-500 transition-transform duration-300">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
            </svg>
          </a>
        </h3>
        <div id="upcoming-shifts" class="bg-white rounded-2xl p-6 hidden">
          <% if @upcoming_shifts.any? %>
            <ul class="space-y-4">
              <% @upcoming_shifts.each do |shift| %>
                <li class="flex justify-between items-center">
                  <div>
                    <p class="font-semibold"><%= shift.location.name %></p>
                    <p class="text-sm text-gray-600"><%= shift.start_time.strftime("%a, %d %b") %>: <%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></p>
                  </div>
                  <span class="px-3 py-1 text-xs text-violet-800 uppercase bg-violet-200 rounded-full"><%= shift.area&.name || "General" %></span>
                </li>
              <% end %>
            </ul>
          <% else %>
            <p class="text-gray-500">No upcoming shifts scheduled.</p>
          <% end %>
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center justify-between">
          Approved Unavailability
          <a href="#approved-unavailability" onclick="document.getElementById('approved-unavailability').classList.toggle('hidden'); this.querySelector('svg').classList.toggle('rotate-180'); return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 text-gray-500 transition-transform duration-300">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
            </svg>
          </a>
        </h3>
        <div id="approved-unavailability" class="hidden">
        <% if @unavailability_requests.any? %>
          <% @unavailability_requests.each do |request| %>
            <div class="bg-white rounded-2xl p-6 mb-4">
              <p class="font-semibold"><%= request.starts_at.strftime("%^b %e") %> - <%= request.ends_at.strftime("%^b %e, %Y") %></p>
              <p class="text-sm text-gray-600"><%= request.reason %></p>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500">No approved unavailability requests.</p>
        <% end %>
        </div>
      </div>
      <% end %>

      <% if current_user&.admin? %>
        <div class="mt-8 bg-white rounded-3xl p-6 sm:p-8">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-gray-800">Comments</h2>
            <%# See more link container aligned right %>
            <% initial = @user.comments.order(created_at: :desc, id: :desc).limit(5).to_a.reverse %>
            <div id="<%= dom_id(@user, :comments_see_more) %>">
              <% if oldest_comment = initial.first %>
                <% has_older = @user.comments.where("(created_at < ?) OR (created_at = ? AND id < ?)", oldest_comment.created_at, oldest_comment.created_at, oldest_comment.id).exists? %>
                <% if has_older %>
                  <%= link_to 'See more', polymorphic_path([@user, :comments], before_id: oldest_comment.id), data: { turbo_stream: true }, class: 'text-violet-700 hover:underline text-sm' %>
                <% end %>
              <% end %>
            </div>
          </div>
          <%# Initial 5 comments (newest 5, display oldest->newest) %>
          <%= render 'comments/list', commentable: @user, comments_for_display: initial %>

          <div id="<%= dom_id(@user, :comments_form) %>">
            <%= render 'comments/form', commentable: @user %>
          </div>
        </div>
      <% end %>
      <!-- File Preview Modal (kept inside controller scope) -->
      <div id="file-preview-modal" class="fixed inset-0 z-50 hidden" data-file-preview-target="modal">
        <div class="absolute inset-0 bg-black/50" data-action="click->file-preview#close"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4" aria-modal="true" role="dialog">
          <div class="relative w-full max-w-xl sm:max-w-lg bg-white rounded-xl shadow-2xl overflow-hidden" data-file-preview-target="container">
            <!-- Close button (always top-right) -->
            <button type="button" class="absolute top-2 right-2 p-2 rounded-full bg-white hover:bg-gray-100 shadow ring-1 ring-black/5" aria-label="Close" title="Close" data-action="click->file-preview#close">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-gray-700">
                <path fill-rule="evenodd" d="M4.22 4.22a.75.75 0 0 1 1.06 0L10 8.94l4.72-4.72a.75.75 0 1 1 1.06 1.06L11.06 10l4.72 4.72a.75.75 0 1 1-1.06 1.06L10 11.06l-4.72 4.72a.75.75 0 0 1-1.06-1.06L8.94 10 4.22 5.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
              </svg>
            </button>
            <div class="p-4 h-96 overflow-auto" data-file-preview-target="content">
              <!-- dynamic content goes here -->
            </div>
            <!-- Footer: file name + remove on left, download on right -->
            <div class="px-4 py-3 border-t flex items-center justify-between gap-3">
              <div class="min-w-0 flex items-center gap-2">
                <button type="button" class="shrink-0 inline-flex items-center justify-center p-2 rounded-full bg-red-50 text-red-500 hover:bg-red-100 hidden" data-file-preview-target="removeButton" data-action="click->file-preview#remove" title="Remove" aria-label="Remove">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                  </svg>
                </button>
                <span class="truncate text-sm text-gray-700" data-file-preview-target="title">Filename</span>
              </div>
              <a href="#" target="_blank" rel="noopener" class="shrink-0 px-4 py-2 rounded-3xl bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm" data-file-preview-target="downloadLink">Download</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>
