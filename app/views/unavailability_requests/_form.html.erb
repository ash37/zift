<%# app/views/unavailability_requests/_form.html.erb %>
<%= form_with(model: unavailability_request, class: "contents") do |form| %>
  <div x-data="{
      type: 'once',
      allDay: <%= unavailability_request.all_day? %>,
      repeatsWeekly: false,
      weekdayText: '',
      updateFromStart() {
        const el = this.$refs.startsDate;
        if (!el || !el.value) { this.weekdayText = ''; return; }
        const d = new Date(el.value);
        const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
        this.weekdayText = days[d.getUTCDay()];
        if (this.repeatsWeekly && this.$refs.endsDate) {
          this.$refs.endsDate.value = el.value;
        }
      }
    }" x-init="updateFromStart()" x-effect="if(repeatsWeekly){ updateFromStart() }">
    <input type="hidden" name="unavailability_request[all_day]" x-bind:value="allDay">

    <div class="max-w-2xl mx-auto bg-white p-6 rounded-3xl mt-8">
      <h2 class="text-lg font-semibold text-gray-700 capitalize dark:text-white"><%= unavailability_request.new_record? ? 'New Unavailability Request' : 'Edit Unavailability Request' %></h2>

      <% if unavailability_request.errors.any? %>
        <div id="error_explanation" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md">
          <h2 class="font-bold"><%= pluralize(unavailability_request.errors.count, "error") %> prohibited this request from being saved:</h2>
          <ul class="list-disc ml-6 mt-2">
            <% unavailability_request.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%# ... (Top part of the form is unchanged) ... %>
       <div class="mb-6 mt-2">
        <label class="flex items-center">
          <input type="checkbox" x-model="allDay" class="form-checkbox h-5 w-5 text-violet-600 rounded">
          <span class="ml-2 text-gray-700">All day</span>
        </label>
      </div>
      <div class="mb-6">
        <label class="flex items-center">
          <input type="checkbox" x-model="repeatsWeekly" class="form-checkbox h-5 w-5 text-violet-600 rounded">
          <span class="ml-2 text-gray-700">Repeats weekly</span>
        </label>
        <!-- Persist as boolean param even if backend isn't ready yet -->
        <input type="hidden" name="unavailability_request[repeats_weekly]" x-bind:value="repeatsWeekly ? '1' : '0'">
        <p x-show="repeatsWeekly" class="mt-2 text-sm text-gray-600">Repeating every week on <span x-text="weekdayText || '-' "></span>.</p>
      </div>

      <div x-show="type === 'once'" x-transition>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
          <div>
            <%= form.label :starts_at, "Start Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.date_field :starts_at, class: "w-full border border-gray-300 rounded-md shadow-sm px-3 py-2", "x-ref": "startsDate", "x-on:input": "updateFromStart()" %>
          </div>
          <div x-show="!repeatsWeekly">
            <%= form.label :ends_at, "End Date", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= form.date_field :ends_at, class: "w-full border border-gray-300 rounded-md shadow-sm px-3 py-2", "x-ref": "endsDate" %>
          </div>
          <div :class="{'hidden': allDay}" class="sm:col-span-2 grid grid-cols-2 gap-6">
            <div>
              <label for="unavailability_request_starts_at_time" class="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
              <%= select_tag "unavailability_request[starts_at_time]",
                             options_for_select(time_options_for_select, selected_time_for(unavailability_request.starts_at) || '09:00'),
                             class: "w-full border border-gray-300 rounded-md shadow-sm px-3 py-2",
                             "x-bind:disabled": "allDay" %>
            </div>
            <div>
              <label for="unavailability_request_ends_at_time" class="block text-sm font-medium text-gray-700 mb-1">End Time</label>
              <%= select_tag "unavailability_request[ends_at_time]",
                             options_for_select(time_options_for_select, selected_time_for(unavailability_request.ends_at) || '17:00'),
                             class: "w-full border border-gray-300 rounded-md shadow-sm px-3 py-2",
                             "x-bind:disabled": "allDay" %>
            </div>
          </div>
        </div>
      </div>
      <%# ... (Repeating section would go here) ... %>

      <div class="mt-8 flex items-end gap-x-4">
        
        <div class="flex-grow">
          <%# FIX: Changed label from "Comment" to "Reason" %>
          <%= form.label :reason, "Reason", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= form.text_field :reason, class: "w-full border border-gray-300 rounded-md shadow-sm px-3 py-2", placeholder: "Add a reason..." %>
        </div>

        <div class="flex-shrink-0 flex items-center gap-4">
          <%# FIX: Updated button styling %>
          <%= form.submit "Save", class: "px-8 py-2.5 leading-5 text-white font-semibold transition-colors duration-300 transform bg-gray-700 rounded-3xl hover:bg-gray-600 focus:outline-none focus:bg-gray-600 h-full" %>

          <% if unavailability_request.persisted? && unavailability_request.starts_at.present? && unavailability_request.starts_at >= 1.week.from_now %>
            <%= link_to "Delete", unavailability_request_path(unavailability_request), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this unavailability request?" }, class: "text-red-600 hover:text-red-800 text-sm" %>
          <% end %>
        </div>
        
      </div>

    </div>
  </div>
<% end %>
