<% content_for :title, "Unavailability Requests" %>

<section class="container px-4 py-4 mx-auto">
  <div class="flex justify-between items-center">
    <div class="flex items-center gap-x-3">
      <h2 class="text-lg font-medium text-gray-800">Unavailability</h2>
      
    </div>
    <div>
      <%= link_to "Add Request", new_unavailability_request_path, class: "rounded-3xl px-3 py-2 bg-zinc-800 hover:bg-zinc-900 text-white font-medium" %>
    </div>
  </div>

  <% visible_requests = (current_user.admin? || current_user.manager?) ? @unavailability_requests : @unavailability_requests.where(user_id: current_user.id) %>

  <div class="mt-6 space-y-3">
    <% visible_requests.each do |unavailability_request| %>
      <% status_text = unavailability_request.status_name
         status_classes = case unavailability_request.status_name.downcase
                          when 'pending'
                            status_text = "Pending Approval"
                            'bg-orange-100 text-orange-500'
                          when 'approved'
                            'bg-green-100 text-green-500'
                          when 'declined'
                            'bg-red-100 text-red-500'
                          end %>

      <div class="mb-4 bg-white rounded-3xl p-4 flex items-start justify-between gap-4" data-controller="clickable-row" data-action="click->clickable-row#visit" data-clickable-row-url-value="<%= edit_unavailability_request_path(unavailability_request) %>">
        <div class="min-w-0">
          <div class="flex items-center gap-2">
            <% if current_user.admin? || current_user.manager? %>
              <div class="font-semibold text-gray-800 truncate"><%= unavailability_request.user.name %></div>
            <% end %>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs <%= status_classes %>"><%= status_text %></span>
          </div>
          <div class="mt-1 text-sm text-gray-700">
            <% if unavailability_request.starts_at.to_date == unavailability_request.ends_at.to_date %>
              <%= unavailability_request.starts_at.strftime("%a, %d %b") %>: <%= format_shift_time(unavailability_request.starts_at) %> - <%= format_shift_time(unavailability_request.ends_at) %>
            <% else %>
              <%= unavailability_request.starts_at.strftime("%a, %d %b") %> - <%= unavailability_request.ends_at.strftime("%a, %d %b") %>
            <% end %>
            <% if unavailability_request.repeats_weekly? %>
              <span class="ml-2 text-gray-400 text-xs" title="Repeats weekly">Repeats weekly</span>
            <% end %>
          </div>
          <% if unavailability_request.reason.present? %>
            <div class="mt-1 text-xs text-gray-500 break-words"><%= unavailability_request.reason %></div>
          <% end %>
        </div>
        <div class="shrink-0 flex items-center gap-2" data-clickable-row-ignore>
          <% if unavailability_request.pending? && (current_user.admin? || current_user.manager?) %>
            <%= button_to "Approve", approve_unavailability_request_path(unavailability_request), method: :patch, class: "px-3 py-1 rounded-3xl bg-emerald-100 text-emerald-800 hover:bg-emerald-200 text-sm" %>
            <%= button_to "Decline", decline_unavailability_request_path(unavailability_request), method: :patch, class: "px-3 py-1 rounded-3xl bg-red-100 text-red-800 hover:bg-red-200 text-sm" %>
          <% else %>
            <% if current_user.admin? || current_user.manager? %>
              <%= link_to "Edit", edit_unavailability_request_path(unavailability_request), class: "px-3 py-1 rounded-3xl bg-gray-100 text-gray-800 hover:bg-gray-200 text-sm" %>
            <% elsif unavailability_request.starts_at.present? && unavailability_request.starts_at >= 1.week.from_now %>
              <%= link_to "Delete", unavailability_request_path(unavailability_request), method: :delete, data: { turbo_confirm: "Are you sure you want to delete this unavailability request?" }, class: "px-3 py-1 rounded-3xl bg-white border border-red-500 text-red-600 hover:bg-red-50 text-sm" %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if visible_requests.empty? %>
      <div class="bg-white rounded-2xl p-6 text-center text-sm text-gray-600">
        You are currently available to be scheduled at anytime. To add times that you are unavailable to do a shift click the Add Request button.
      </div>
    <% end %>
  </div>
</section>
