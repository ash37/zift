<% content_for :title, "Unavailability Requests" %>

<section class="container px-4 py-4 mx-auto">
  <div class="flex justify-between items-center">
    <div class="flex items-center gap-x-3">
      <h2 class="text-lg font-medium text-gray-800">Unavailability</h2>
      
    </div>
    <div>
      <%= link_to "Add Request", new_unavailability_request_path, class: "rounded-3xl px-3 py-2 bg-zinc-800 hover:bg-zinc-900 text-white font-medium" %>
    </div>
  </div>

  <div class="flex flex-col mt-6">
    <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
      <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
        <div class="overflow-hidden border border-gray-200 md:rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <% if current_user.admin? || current_user.manager? %>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                <% end %>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Period</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <% if current_user.admin? || current_user.manager? %>
                  <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                <% end %>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% visible_requests = (current_user.admin? || current_user.manager?) ? @unavailability_requests : @unavailability_requests.where(user_id: current_user.id) %>
              <% visible_requests.each do |unavailability_request| %>
                <tr data-controller="clickable-row" data-action="click->clickable-row#visit" data-clickable-row-url-value="<%= edit_unavailability_request_path(unavailability_request) %>">
                  <% if current_user.admin? || current_user.manager? %>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><%= unavailability_request.user.name %></td>
                  <% end %>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <% if unavailability_request.starts_at.to_date == unavailability_request.ends_at.to_date %>
                      <%= unavailability_request.starts_at.strftime("%a, %d %b") %>: <%= format_shift_time(unavailability_request.starts_at) %> - <%= format_shift_time(unavailability_request.ends_at) %>
                    <% else %>
                      <%= unavailability_request.starts_at.strftime("%a, %d %b") %> - <%= unavailability_request.ends_at.strftime("%a, %d %b") %>
                    <% end %>
                    <% if unavailability_request.repeats_weekly? %>
                      <span class="inline-block ml-2 text-gray-400" title="Repeats weekly">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3" />
                        </svg>
                      </span>
                    <% end %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= unavailability_request.reason %></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <% status_text = unavailability_request.status_name
                       status_classes = case unavailability_request.status_name.downcase
                                        when 'pending'
                                          status_text = "Pending Approval"
                                          'bg-red-100/60 text-red-800'
                                        when 'approved'
                                          'bg-emerald-100/60 text-emerald-800'
                                        when 'declined'
                                          'bg-gray-100/60 text-gray-800'
                                        end %>
                    <div class="inline-flex items-center px-3 py-1 rounded-full gap-x-2 text-xs <%= status_classes %>">
                      <%= status_text %>
                    </div>
                  </td>
                  <% if current_user.admin? || current_user.manager? %>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                      <% if unavailability_request.pending? && (current_user.admin? || current_user.manager?) %>
                        <%= button_to "Approve", approve_unavailability_request_path(unavailability_request), method: :patch, class: "text-emerald-600 hover:text-emerald-900" %>
                        <%= button_to "Decline", decline_unavailability_request_path(unavailability_request), method: :patch, class: "text-red-600 hover:text-red-900" %>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
              <% if visible_requests.empty? %>
                <tr>
                  <td colspan="<%= (current_user.admin? || current_user.manager?) ? 5 : 3 %>" class="px-6 py-4 text-center text-sm text-gray-600">
                    You are currently available to be scheduled at anytime. To add times that you are unavailable to do a shift click the Add Request button.
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>