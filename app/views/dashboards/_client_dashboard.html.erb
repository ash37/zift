<%#
  Default locals for when this partial is rendered without `locals:`.
  If the controller passes `selected_date`, `loc`, or `shifts`, the `||=` will keep them.
%>
<% selected_date ||= begin
     raw = params[:date].presence
     raw ? Date.parse(raw.to_s) : Date.current
   rescue ArgumentError, TypeError
     Date.current
   end %>

<% loc ||= begin
     if current_user.respond_to?(:location) && current_user.location.present?
       current_user.location
     elsif current_user.respond_to?(:client_location) && current_user.client_location.present?
       current_user.client_location
     elsif current_user.respond_to?(:locations) && current_user.locations.respond_to?(:first)
       current_user.locations.first
     else
       nil
     end
   end %>

<% shifts ||= begin
     scope = Shift.joins(:roster)
     scope = scope.where(rosters: { status: Roster::STATUSES[:published] })
     scope = scope.where(location_id: loc.id) if loc.present?
     scope = scope.where(start_time: selected_date.beginning_of_day..selected_date.end_of_day)
     scope.includes(:user, :location, :timesheets, :roster)
   end %>


<%= render "dashboards/client_sub_nav", selected_date: selected_date %>



    <% if shifts.empty? %>
      <div class="rounded-md border border-gray-200 bg-white p-6 text-gray-600">
        No shifts scheduled for <%= (loc&.name || "your client") %> on <%= selected_date.strftime("%-d %b %Y") %>.
      </div>
    <% else %>
      <div class="p-4 grid sm:grid-cols-2 lg:grid-cols-3">
        <% shifts.each do |shift| %>
          <% timesheet = shift.respond_to?(:timesheets) ? shift.timesheets.first : nil %>
          <div id="<%= dom_id(shift, :client_card) %>"
               class="w-full max-w-md px-4 py-3 bg-white rounded-3xl mb-4">
            <div class="flex items-center justify-between">
              <h3 class="text-base text-lg font-semibold text-gray-900 ml-2">
                <%= (shift.user.try(:full_name) || shift.user&.name || "—") %>
              </h3>
              <% if timesheet %>
                <%
                  status_name = timesheet.respond_to?(:status_name) ? timesheet.status_name.to_s : (timesheet.try(:status) || "pending").to_s
                  status_key = status_name.downcase
                  status_classes =
                    case status_key
                    when 'approved'
                      'bg-green-100 text-green-600'
                    when 'rejected'
                      'bg-red-100 text-red-700'
                    when 'started', 'auto'
                      'bg-orange-100 text-orange-700'
                    else
                      'bg-yellow-100 text-yellow-700'
                    end
                %>
                <span class="px-3 py-1 text-xs uppercase rounded-full <%= status_classes %>"><%= status_name.titleize %></span>
              <% else %>
                <span class="px-3 py-1 text-xs uppercase bg-gray-100/60 rounded-full text-violet-700"><% if shift.respond_to?(:area) && shift.area.present? %><%= shift.area.name %><% end %></span>

              <% end %>
            </div>

            <div class="mt-1">
              

              <% if timesheet %>
                <% if timesheet.respond_to?(:notes) && timesheet.notes.to_s.include?("Auto-generated: Missed clock on.") %>
                  <p class="text-sm text-orange-600">Unattended</p>
                <% else %>
                  <p class="text-sm text-gray-700">
                    Worked:
                    <% clock_in = timesheet.try(:clock_in_at) %>
                    <% clock_out = timesheet.try(:clock_out_at) %>
                    <%= clock_in ? clock_in.strftime("%I:%M%p") : "—" %>
                    -
                    <%= clock_out ? clock_out.strftime("%I:%M%p") : "—" %>
                  </p>
                <% end %>
              <% end %>

              <%
                scheduled_class = "text-md text-gray-600 ml-2"
                if timesheet && timesheet.respond_to?(:duration_in_hours) && shift.respond_to?(:duration_in_hours)
                  if (timesheet.duration_in_hours.to_f - shift.duration_in_hours.to_f).abs > 0.01
                    scheduled_class = "text-xs text-orange-600"
                  end
                end
                start_label = (defined?(format_shift_time) && shift.start_time) ? format_shift_time(shift.start_time) : (shift.start_time ? l(shift.start_time, format: :short) : "—")
                end_label   = (defined?(format_shift_time) && shift.end_time)   ? format_shift_time(shift.end_time)   : (shift.end_time ? l(shift.end_time, format: :short) : "—")
              %>
              <p class="<%= scheduled_class %>">
                <%= start_label %> - <%= end_label %>
              </p>

              <% if shift.try(:notes).present? %>
                <p class="mt-1 text-xs text-gray-500">
                  <%= truncate(shift.notes.to_s, length: 140) %>
                </p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
<%# Copy JSON URL button for clients %>
<% if defined?(current_user) && current_user.present? %>
  <% show_copy = if current_user.respond_to?(:client?) 
                   current_user.client?
                 elsif defined?(User::ROLES) && User::ROLES.is_a?(Hash)
                   current_user.role.to_i == (User::ROLES[:client] || User::ROLES["client"])
                 else
                   false
                 end %>
  <% if show_copy %>
    <% token = current_user.respond_to?(:client_dashboard_token) ? current_user.client_dashboard_token : nil %>
    <% json_url = begin
         if respond_to?(:client_dashboard_url)
           client_dashboard_url(format: :json, token: token, date: selected_date.to_s)
         else
           url_for(controller: "dashboards", action: "client_dashboard", format: :json, token: token, date: selected_date.to_s)
         end
       rescue
         "#"
       end %>
    <div class="mb-3 flex w-full justify-center">
      <button
        type="button"
        class="inline-flex items-center gap-2 rounded-full bg-violet-500/10 px-3 py-1 text-xs font-medium text-violet-700 hover:bg-violet-500/20"
        data-url="<%= json_url %>"
        onclick="navigator.clipboard.writeText(this.dataset.url).then(()=>{ const t=this; const old=t.textContent; t.textContent='Copied!'; setTimeout(()=>{t.textContent=old;},1500); }).catch(()=>{ alert('Unable to copy.'); });"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
        </svg>
        Copy JSON URL
      </button>
    </div>
  <% end %>
<% end %>
