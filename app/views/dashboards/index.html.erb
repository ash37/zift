<% if current_user.respond_to?(:client?) && current_user.client? %>
  <%= render partial: "client_dashboard", locals: { date: params[:date].present? ? Time.zone.parse(params[:date]).to_date : Time.zone.today } %>
<% else %>
<%
  today_range = Time.zone.today.beginning_of_day..Time.zone.today.end_of_day

  today_shifts = current_user.shifts
                             .includes(:timesheets)
                             .where(start_time: today_range)
                             .joins(:roster)
                             .where(rosters: { status: Roster::STATUSES[:published] })
                             .left_joins(:timesheets)
                             .where("timesheets.id IS NULL OR timesheets.clock_out_at IS NULL")
                             .order('shifts.start_time ASC')

  upcoming_shifts = current_user.shifts
                                .joins(:roster)
                                .where(rosters: { status: Roster::STATUSES[:published] })
                                .where("shifts.start_time >= ?", Time.zone.tomorrow.beginning_of_day)
                                .order(:start_time)
                                .limit(5)
%>

<section class="container px-4 py-4 mx-auto bg-transparent">
  
  <div class="mt-6 space-y-8">
    <div>
      <% has_in_progress = current_user.timesheets.where(clock_out_at: nil).exists? %>
      <% if today_shifts.any? %>
        <div class="flex justify-end items-center">
          <% if has_in_progress %>
            <button type="button"
                    onclick="alert('You need to clock off from your current shift before starting a new unscheduled shift.')"
                    class="bg-white text-gray-400 py-1 px-4 rounded-3xl cursor-not-allowed">
              Start Unscheduled Shift
            </button>
          <% else %>
            <%= link_to "Start Unscheduled Shift", new_timesheet_path, class: "bg-white text-gray-400 py-1 px-4 rounded-3xl" %>
          <% end %>
        </div>
      <% end %>

      <%# Show in-progress unscheduled shifts with a Clock Off button %>
      <% in_progress_timesheets = current_user.timesheets.includes(shift: [:roster, :location, :area]).where(clock_out_at: nil) %>
      <% unscheduled_in_progress = in_progress_timesheets.select { |ts| ts.shift&.roster&.draft? } %>
      <% if unscheduled_in_progress.any? %>
        <div class="mt-4 space-y-4">
          <% unscheduled_in_progress.each do |timesheet| %>
            <% shift = timesheet.shift %>
            <div class="p-4 bg-white rounded-3xl flex justify-between items-center">
              <div class="flex items-center gap-x-3">
                <div>
                  <p class="text-2xl font-bold"><%= format_shift_time(timesheet.clock_in_at) %> - Now</p>
                  <% if shift&.location %>
                    <p class="text-sm text-violet-700"><%= shift.location.name %></p>
                  <% end %>
                  <% if shift&.area %>
                    <p class="text-sm text-gray-500"><%= shift.area.name %></p>
                  <% end %>
                  <p class="text-sm text-gray-500">Unscheduled</p>
                </div>
              </div>

              <div x-data="{
                    clockedInAt: '<%= timesheet.clock_in_at&.iso8601 %>',
                    canClockOff: false,
                    init() {
                      const five = 5 * 60 * 1000;
                      const t = new Date(this.clockedInAt).getTime();
                      const now = Date.now();
                      if (!t || (now - t) >= five) { this.canClockOff = true; return }
                      setTimeout(() => { this.canClockOff = true }, five - (now - t));
                    }
                  }" class="flex items-center gap-x-4">
                <a :href="canClockOff ? '<%= clock_off_form_timesheet_path(timesheet) %>' : '#'"
                   :class="{ 'opacity-50 cursor-not-allowed': !canClockOff }"
                   class="px-4 py-3 text-md font-bold text-white bg-red-500 rounded-full hover:bg-red-600">Clock Off</a>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      <div class="mt-4 space-y-4">
        <% if today_shifts.any? %>
          <% today_shifts.each do |shift| %>
            <%
              timesheet = shift.timesheets.first
              missed_clock_on = false
              if timesheet.nil? && Time.current > (shift.start_time + 3.hours)
                timesheet = shift.timesheets.create(
                  user: current_user,
                  status: Timesheet::STATUSES[:pending],
                  clock_in_at: shift.start_time,
                  clock_out_at: shift.end_time,
                  notes: "Auto-generated: Missed clock on."
                )
                missed_clock_on = true
              elsif timesheet&.notes&.include?("Auto-generated") && timesheet.pending?
                missed_clock_on = true
              end
            %>
            <div class="p-4 bg-white rounded-3xl flex justify-between items-center"
              data-controller="clickable-row"
              data-action="click->clickable-row#visit"
              data-clickable-row-url-value="<%= shift_path(shift) %>"
            >
              <div class="flex items-center gap-x-3">
                <% if missed_clock_on %>
                  <div title="Missed clock on. A timesheet has been automatically created for review.">
                    <div class="bg-red-100 rounded-full p-1">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-500">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                      </svg>
                    </div>
                  </div>
                <% end %>
                <div>
                  <p class="text-2xl font-bold"><%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></p>
                  <p class="text-sm text-violet-700"><%= shift.location.name %></p>
                  <% if shift.area.present? %>
                    <p class="text-sm text-gray-500"><%= shift.area.name %></p>
                  <% end %>
                  <% if shift.note.present? %>
                    <p class="text-sm text-violet-700"><em><%= shift.note %></em></p>
                  <% end %>
                </div>
              </div>
              <%= render 'shift_actions', shift: shift, upcoming: false, timesheet: timesheet %>
            </div>
          <% end %>
        <% else %>
          <div class="relative overflow-hidden rounded-3xl px-6 sm:px-7 py-16 sm:py-20 bg-white/40 backdrop-blur-xl ring-1 ring-inset ring-white/60 space-y-6">
            <div class="pointer-events-none absolute -inset-8 rounded-[2rem] blur-2xl opacity-60" style="background: radial-gradient(60% 60% at 80% 10%, rgba(59,130,246,0.18) 0%, rgba(99,102,241,0.14) 40%, rgba(139,92,246,0.10) 70%, rgba(255,255,255,0) 100%);"></div>
            <div class="pointer-events-none absolute -top-10 -left-10 h-40 w-40 rounded-full blur-3xl bg-gradient-to-bl from-indigo-300/40 via-violet-300/30 to-transparent"></div>
            <div class="pointer-events-none absolute -bottom-10 -right-10 h-40 w-40 rounded-full blur-3xl bg-gradient-to-tl from-blue-300/35 via-indigo-300/25 to-transparent"></div>
            <div class="pointer-events-none absolute inset-0 rounded-3xl bg-gradient-to-tr from-white/40 via-transparent to-transparent"></div>
            <div class="relative flex items-center gap-3 text-slate-700 justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 shrink-0 text-orange-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
              </svg>
              <p class="font-semibold text-slate-800">No shifts scheduled for today.</p>
            </div>
            <div class="relative flex justify-center">
              <% if has_in_progress %>
                <button type="button"
                        onclick="alert('You need to clock off from your current shift before starting a new unscheduled shift.')"
                        class="bg-white text-gray-400 py-1 px-4 rounded-3xl cursor-not-allowed">
                  Start Unscheduled Shift
                </button>
              <% else %>
                <%= link_to "Start Unscheduled Shift", new_timesheet_path, class: "bg-white text-violet-500 hover:text-violet-600 py-1 px-4 rounded-3xl" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div>
      <h3 class="text-md font-medium text-gray-700">Upcoming</h3>
      <div class="mt-4 space-y-4">
        <% if upcoming_shifts.any? %>
          <% upcoming_shifts.each do |shift| %>
            <div class="p-4 bg-white rounded-3xl flex justify-between items-center">
              <div>
                <p class="font-semibold"><%= shift.start_time.strftime("%A") %></p>
                <p class="font-semibold"><%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></p>
                <p class="text-sm text-gray-600"><%= shift.location.name %></p>
              </div>
              <%= render 'shift_actions', shift: shift, upcoming: true %>
              <span class="rounded-3xl bg-violet-100 px-2 py-1 text-xs text-violet-500 mr-4"><%= shift.start_time.strftime("%d %b").upcase %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500">No upcoming shifts.</p>
        <% end %>
      </div>
    </div>
  </div>
</section>
<% end %>
