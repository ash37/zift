<%= form_with(model: @timesheet, url: timesheets_path, method: :post) do |form| %>
  <% if @timesheet.errors.any? || @timesheet.shift.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mb-6">
      <h2>Errors prohibited this from being saved:</h2>
      <ul class="list-disc ml-6 mt-2">
        <% @timesheet.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
        <% @timesheet.shift.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% available_locations = @available_locations || Location.none %>
  <% areas_by_location = (@areas_by_location || {}).transform_keys(&:to_s) %>

  <%= form.fields_for :shift, @timesheet.shift do |shift_form| %>
    <div class="mb-4">
      <%= shift_form.label :location_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= shift_form.collection_select :location_id, available_locations, :id, :name,
            { prompt: "Select a client" },
            { class: "block w-full rounded-md border-gray-300 shadow-sm", required: true, id: "shift_location_id", data: { behavior: "location-select" } } %>
    </div>
    <div class="mb-4">
      <%= shift_form.label :area_id, class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= select_tag "timesheet[shift_attributes][area_id]",
            options_for_select([["Select an area", ""]]),
            id: "shift_area_id",
            class: "block w-full rounded-md border-gray-300 shadow-sm",
            disabled: true,
            data: { behavior: "area-select" } %>
    </div>

    <%# Serialize Areas grouped by Location to JSON for the client-side filter %>
    <script type="application/json" id="areas-by-location-data"><%= raw(areas_by_location.to_json) %></script>

    <script>
      (function() {
        function ready(fn){ if(document.readyState !== 'loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
        ready(function(){
          var locSelect = document.getElementById('shift_location_id');
          var areaSelect = document.getElementById('shift_area_id');
          var dataTag = document.getElementById('areas-by-location-data');
          if(!locSelect || !areaSelect || !dataTag) return;
          var map = {};
          try { map = JSON.parse(dataTag.textContent || '{}'); } catch(e) { map = {}; }

          function populateAreas(locId){
            // Clear current options
            while (areaSelect.firstChild) { areaSelect.removeChild(areaSelect.firstChild); }
            var placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select an area';
            areaSelect.appendChild(placeholder);

            var list = map[String(locId)] || [];
            list.forEach(function(item){
              var opt = document.createElement('option');
              opt.value = item.id;
              opt.textContent = item.name;
              areaSelect.appendChild(opt);
            });

            areaSelect.disabled = list.length === 0;
          }

          // Initial state: disabled until a location is chosen
          areaSelect.disabled = true;

          // If the page was re-rendered with a selected location (validation errors), restore options
          if (locSelect.value) { populateAreas(locSelect.value); }

          locSelect.addEventListener('change', function(e){
            var val = e.target.value;
            if (val) { populateAreas(val); } else { areaSelect.disabled = true; while (areaSelect.firstChild) { areaSelect.removeChild(areaSelect.firstChild); } var ph = document.createElement('option'); ph.value=''; ph.textContent='Select an area'; areaSelect.appendChild(ph); }
          });
        });
      })();
    </script>
  <% end %>

  <p class="text-gray-600 mb-4">You are clocking in now: <%= Time.current.strftime("%-l:%M %p") %></p>

  <%= form.submit "Start Unscheduled Shift", class: "bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-3xl" %>
<% end %>
