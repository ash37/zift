<% content_for :title, "Timesheets" %>

<%= render 'sub_nav' %>

<div class="container px-0 sm:px-4 mx-auto">
  <div class="hidden sm:block">
    <div class="flex flex-col mt-6">
      <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
        <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
          <div class="overflow-hidden border border-gray-200 dark:border-gray-700 md:rounded-lg">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-800">
                <tr>
                  <th scope="col" class="py-3.5 px-4 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">Employee</th>
                  <th scope="col" class="px-4 py-3.5 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">Date</th>
                  <th scope="col" class="px-4 py-3.5 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">Time</th>
                  <th scope="col" class="px-4 py-3.5 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">Hours</th>
                  <th scope="col" class="px-4 py-3.5 text-sm font-normal text-left rtl:text-right text-gray-500 dark:text-gray-400">Status</th>
                  <th scope="col" class="relative py-3.5 px-4"><span class="sr-only">Actions</span></th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200 dark:divide-gray-700 dark:bg-gray-900">
                <% @shifts.each do |shift| %>
                  <% timesheet = shift.timesheets.first %>
                  <tr <% if timesheet && (current_user.admin? || current_user.manager?) && shift.start_time.to_date <= Date.today %>
                        data-controller="clickable-row"
                        data-action="click->clickable-row#visit"
                        data-clickable-row-url-value="<%= edit_timesheet_path(timesheet) %>"
                      <% end %>
                      class="hover:bg-gray-50 dark:hover:bg-gray-800"
                  >
                    <td class="px-4 py-4 text-sm font-medium text-gray-700 whitespace-nowrap dark:text-white"><%= shift.user.name %>
                    <p class="text-xs text-gray-500 dark:text-gray-400"><%= [shift.area&.name, shift.location.name].compact.join(' - ') %></p>
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-500 dark:text-gray-300 whitespace-nowrap"><%= shift.start_time.strftime("%a, %d %b") %></td>
                    <td class="px-4 py-4 text-sm text-gray-500 dark:text-gray-300 whitespace-nowrap">
                      <% if timesheet %>
                        <div><%= timesheet.clock_in_at&.strftime("%I:%M%p") %> - <%= timesheet.clock_out_at&.strftime("%I:%M%p") %></div>
                      <% end %>
                      <div class="text-xs text-gray-400">Rostered: <%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></div>
                    </td>
                    <td class="px-4 py-4 text-sm text-gray-500 dark:text-gray-300 whitespace-nowrap">
                      <% if timesheet %>
                        <div><%= number_with_precision(timesheet.duration_in_hours, precision: 2) %>h</div>
                      <% end %>
                      <div class="text-xs text-gray-400">Rostered: <%= number_with_precision(shift.duration_in_hours, precision: 2) %>h</div>
                    </td>
                    <td class="px-4 py-4 text-sm font-medium text-gray-700 whitespace-nowrap">
                      <% if timesheet %>
                        <%
                          status_classes = case timesheet.status_name.downcase
                                           when 'approved'
                                             'bg-green-100 text-green-800'
                                           when 'rejected'
                                             'bg-red-100 text-red-800'
                                           when 'started', 'auto'
                                             'bg-orange-100 text-orange-800'
                                           else # pending
                                             'bg-yellow-100 text-yellow-800'
                                           end
                        %>
                        <div class="inline-flex items-center px-3 py-1 rounded-full gap-x-2 <%= status_classes %>">
                          <% if timesheet.auto_clock_off? %>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                          <% end %>
                          <h2 class="text-sm font-normal"><%= timesheet.status_name.titleize %></h2>
                        </div>
                      <% else %>
                        <div class="inline-flex items-center px-3 py-1 rounded-full gap-x-2 bg-gray-100/60">
                          <h2 class="text-sm font-normal">Not Started</h2>
                        </div>
                      <% end %>
                    </td>
                    <td class="px-4 py-4 text-sm whitespace-nowrap text-right">
                      <% if timesheet && (current_user.admin? || current_user.manager?) %>
                        <div class="flex items-center gap-x-3 justify-end">
                          <% if timesheet.pending? %>
                            <%= link_to "Match Roster", match_roster_times_timesheet_path(timesheet), method: :patch, class: "text-violet-800 hover:bg-violet-100 hover:rounded-3xl px-2 py-1" %>
                            <%= button_to approve_timesheet_path(timesheet), method: :patch, class: "bg-green-500 hover:bg-green-700 text-white font-semibold p-2 rounded-full" do %>
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                              </svg>
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="sm:hidden">
    <% @shifts.group_by { |s| s.start_time.to_date }.each do |date, shifts_for_day| %>
      <div class="mt-1">
        <div class="text-lg font-bold text-gray-800 dark:text-white px-4"><%= date.strftime("%A, %d %B") %></div>
        <div class="mt-1 space-y-2">
          <% shifts_for_day.each do |shift| %>
            <% timesheet = shift.timesheets.first %>
            <div <% if timesheet && (current_user.admin? || current_user.manager?) && shift.start_time.to_date <= Date.today %>
                  data-controller="clickable-row"
                  data-action="click->clickable-row#visit"
                  data-clickable-row-url-value="<%= edit_timesheet_path(timesheet) %>"
                <% end %>
                class="bg-white dark:bg-gray-800 p-4 shadow-sm relative"
            >
              <div class="flex justify-between">
                <div>
                  <p class="font-bold text-gray-800 dark:text-white"><%= shift.user.name %></p>
                  <% if timesheet %>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Worked: <%= timesheet.clock_in_at&.strftime("%I:%M%p") %> - <%= timesheet.clock_out_at&.strftime("%I:%M%p") %></p>
                  <% end %>
                  <p class="text-xs text-gray-500 dark:text-gray-400"><%= [shift.area&.name, shift.location.name].compact.join(' - ') %></p>
                  <%
                    rostered_time_class = "text-xs text-violet-700 dark:text-violet-600"
                    if timesheet && (timesheet.duration_in_hours - shift.duration_in_hours).abs > 0.01
                      rostered_time_class = "text-xs text-orange-500 dark:text-orange-400"
                    end
                  %>
                  <p class="<%= rostered_time_class %>">Scheduled: <%= format_shift_time(shift.start_time) %> - <%= format_shift_time(shift.end_time) %></p>
                </div>
                <div class="text-right">
                  <% if timesheet %>
                    <%
                      status_classes = case timesheet.status_name.downcase
                                       when 'approved'
                                         'bg-green-100 text-green-800'
                                       when 'rejected'
                                         'bg-red-100 text-red-800'
                                       when 'started', 'auto'
                                         'bg-orange-100 text-orange-800'
                                       else # pending
                                         'bg-yellow-100 text-yellow-800'
                                       end
                    %>
                    <div class="inline-flex items-center px-2 py-1 rounded-full gap-x-1 text-xs <%= status_classes %>">
                      <% if timesheet.auto_clock_off? %>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                      <% end %>
                      <%= timesheet.status_name.titleize %>
                    </div>
                    <% if timesheet && (current_user.admin? || current_user.manager?) && timesheet.pending? %>
                      <div class="flex items-center gap-x-3 justify-end mt-2">
                        <%= link_to "Match", match_roster_times_timesheet_path(timesheet), method: :patch, class: "text-violet-800 hover:bg-violet-100 hover:rounded-3xl px-2 py-1" %>
                        <%= button_to approve_timesheet_path(timesheet), method: :patch, class: "bg-green-500 hover:bg-green-700 text-white font-semibold p-2 rounded-full" do %>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                          </svg>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="inline-flex items-center px-2 py-1 rounded-full gap-x-1 text-xs bg-gray-100/60 text-gray-800">
                      Not Started
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>