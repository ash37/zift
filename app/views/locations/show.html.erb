<%# app/views/locations/show.html.erb %>
<div class="bg-zinc-100 min-h-screen">
  <section class="container mx-auto px-4 py-10">
    <div class="w-full max-w-4xl mx-auto">

      <div class="relative bg-white rounded-2xl p-6 flex items-start justify-between">
       

        <div class="flex items-center min-w-0">
          <div class="text-left">
            <h1 class="text-2xl font-bold text-gray-800 truncate"><%= @location.name %></h1>
            
          </div>
        </div>

        <div class="ml-4 flex items-center gap-3">
          
            <%= link_to "Edit", edit_location_path(@location), class: "px-4 py-2 text-sm font-semibold text-violet-700 hover:text-violet-900" %>
            
        </div>
      </div>


      <!-- Service Agreement -->
      <% current_service_agreement = Agreement.current_for('service') %>
      <% # Find the latest signed acceptance for any service agreement version %>
      <% latest_signed_acceptance = LocationAgreementAcceptance
        .joins(:agreement)
        .where(location: @location, agreements: { document_type: 'service' })
        .order(Arel.sql("CASE WHEN signed_at IS NULL THEN 1 ELSE 0 END"))
        .order(signed_at: :desc, created_at: :desc)
        .first %>
      <% # Find a pending acceptance for the current active agreement (if any) %>
      <% pending_current_acceptance = current_service_agreement && LocationAgreementAcceptance
        .where(location: @location, agreement: current_service_agreement, signed_at: nil)
        .order(created_at: :desc)
        .first %>
      <div class="mt-4 bg-white rounded-3xl p-6 sm:p-8 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-gray-800 mb-1">Service Agreement</h2>
          <% if current_service_agreement.present? %>
            <% if latest_signed_acceptance&.signed_at.present? %>
              <div class="text-sm text-green-700">Complete — signed <%= latest_signed_acceptance.signed_at.strftime('%-d %b %Y') %></div>
            <% elsif pending_current_acceptance.present? %>
              <div class="text-sm text-orange-500">Outstanding — please review and accept</div>
            <% else %>
              <div class="text-sm text-gray-600">No acceptance on record for the current agreement.</div>
            <% end %>
          <% else %>
            <div class="text-sm text-gray-600">No active service agreement configured.</div>
          <% end %>
        </div>
        <div class="flex items-center gap-2">
          <% if latest_signed_acceptance&.signed_at.present? %>
            <%= link_to "View", service_agreement_path(latest_signed_acceptance.token), class: "px-3 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
          <% end %>
          <% if current_service_agreement.present? %>
            <% if current_user.admin? %>
              <% if pending_current_acceptance.present? %>
                <%= button_to "Resend link", resend_service_agreement_location_path(@location), method: :post, class: "ml-2 px-3 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
              <% else %>
                <%= button_to "Send for signature", send_service_agreement_location_path(@location), method: :post, class: "ml-2 px-3 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
              <% end %>
            <% end %>
          <% elsif current_user&.admin? %>
            <%= link_to "Configure", new_admin_agreement_path(document_type: 'service'), class: "px-3 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200" %>
          <% end %>
        </div>
      </div>

      <!-- Additional Information -->
      <div class="mt-4 bg-white rounded-3xl p-6 sm:p-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Additional Information</h2>
        <% rep_name   = @location.representative_name.presence %>
        <% rep_email  = @location.representative_email.presence %>
        <% email_disp = @location.email.presence %>
        <% phone_disp = @location.phone.presence %>
        <% dob_disp   = @location.date_of_birth.present? ? @location.date_of_birth.strftime('%-d %b %Y').upcase : nil %>
        <% ndis_disp  = @location.ndis_number.presence %>
        <% funding    = @location.funding.presence %>
        <% pm_email   = @location.plan_manager_email.presence %>
        <% gender     = @location.gender.presence %>
        <% lives_with = @location.lives_with.presence %>
        <% pets       = @location.pets.presence %>

        <% interview  = @location.interview_info.presence %>
        <% schedule   = @location.schedule_info.presence %>
        <% activities = @location.activities_of_interest.presence %>
        <% tasks      = @location.tasks.presence %>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <%# Representative Name %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Representative name</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= rep_name || '—' %></div>
            </div>
          </div>

          <%# Representative Email %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Representative email</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= rep_email || '—' %></div>
            </div>
          </div>

          <%# Email %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Email</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= email_disp || '—' %></div>
            </div>
          </div>

          <%# Phone %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Phone</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= phone_disp || '—' %></div>
            </div>
          </div>

          <%# Date of birth %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg class="h-5 w-5 text-violet-600" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M7 3v3M17 3v3M3 11h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <rect x="3" y="6" width="18" height="15" rx="2" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Date of birth</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= dob_disp || '—' %></div>
            </div>
          </div>

          <%# NDIS Number %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.746 3.746 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">NDIS number</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= ndis_disp || '—' %></div>
            </div>
          </div>

          <%# Funding %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Funding</div>
              <div>
                <% if funding.present? %>
                  <span class="inline-flex items-center rounded-3xl px-3 py-1 text-xs font-medium bg-violet-700 text-white"><%= funding %></span>
                <% else %>
                  <span class="text-gray-800">—</span>
                <% end %>
              </div>
            </div>
          </div>

          <%# Plan Manager Email %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Plan manager email</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= pm_email || '—' %></div>
            </div>
          </div>

          <%# Gender %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Gender</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= gender || '—' %></div>
            </div>
          </div>

          <%# Lives with %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
              </svg>
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Lives with</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= lives_with || '—' %></div>
            </div>
          </div>

          <%# Pets %>
          <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" class="h-6 w-6 text-violet-600" fill="currentColor" aria-hidden="true">
                <path d="M153.6 614.4c-57.4464 0-102.4-67.6864-102.4-154.1632s44.9536-154.1632 102.4-154.1632S256 373.76 256 460.2368 211.0464 614.4 153.6 614.4z m0-257.1264c-24.1664 0-51.2 44.032-51.2 102.9632S129.4336 563.2 153.6 563.2s51.2-44.032 51.2-102.9632-27.0336-102.9632-51.2-102.9632zM358.2976 409.6C300.9536 409.6 256 342.1184 256 256s44.9536-153.6 102.2976-153.6 102.2976 67.4816 102.2976 153.6-44.9536 153.6-102.2976 153.6z m0-256C334.1824 153.6 307.2 197.376 307.2 256s26.9824 102.4 51.0976 102.4 51.0976-43.776 51.0976-102.4-26.9824-102.4-51.0976-102.4zM614.4 409.6c-57.4464 0-102.4-67.4816-102.4-153.6s44.9536-153.6 102.4-153.6 102.4 67.4816 102.4 153.6-44.9536 153.6-102.4 153.6z m0-256c-24.1664 0-51.2 43.776-51.2 102.4s27.0336 102.4 51.2 102.4 51.2-43.776 51.2-102.4-27.0336-102.4-51.2-102.4zM819.2 614.4c-57.4464 0-102.4-67.6864-102.4-154.1632s44.9536-154.1632 102.4-154.1632 102.4 67.6864 102.4 154.1632S876.6464 614.4 819.2 614.4z m0-257.1264c-24.1664 0-51.2 44.032-51.2 102.9632S795.0336 563.2 819.2 563.2s51.2-44.032 51.2-102.9632-27.0336-102.9632-51.2-102.9632zM665.6 921.6c-44.4416 0-74.496-15.0528-100.9664-28.3136-24.576-12.288-45.7728-22.8864-78.2336-22.8864-32.3072 0-53.504 10.5984-78.08 22.8864C381.7472 906.5472 351.6416 921.6 307.2 921.6c-28.4672 0-55.2448-15.5136-73.5744-42.5472-32.1024-47.4112-32.6144-119.3472-1.4336-197.376C288.3584 541.2864 380.9792 460.8 486.3488 460.8s198.0416 80.4864 254.1568 220.8768c31.1808 78.0288 30.6688 149.9648-1.4336 197.376-18.2784 27.0336-45.1072 42.5472-73.5744 42.5472z m-179.2-102.4c44.4928 0 74.5984 15.0528 101.12 28.3136 24.5248 12.288 45.7216 22.8864 78.08 22.8864 11.1616 0 22.528-7.3216 31.1808-20.0192 22.1184-32.6144 20.6848-88.576-3.7376-149.6576C645.0688 580.8128 569.7536 512 486.4 512s-158.6688 68.7616-206.6432 188.7232c-24.4224 61.0816-25.8048 117.0432-3.7376 149.6576 8.6016 12.7488 19.968 20.0192 31.1808 20.0192 32.3584 0 53.6064-10.5984 78.2336-22.9376 26.5216-13.2608 56.6272-28.3136 100.9664-28.3136z"/>
              </svg>
              
            </div>
            <div class="min-w-0">
              <div class="text-xs uppercase tracking-wide text-gray-500">Pets</div>
              <div class="text-gray-800 break-all sm:break-normal"><%= pets || '—' %></div>
            </div>
          </div>
        </div>

        <% if interview || schedule || activities || tasks %>
          <div class="mt-6 grid grid-cols-1 gap-4">
            <%# Long text blocks %>
            <% [["Interview info", interview], ["Schedule info", schedule], ["Activities of interest", activities], ["Tasks", tasks]].each do |label, value| %>
              <% next unless value.present? %>
              <div class="flex items-start gap-3 p-3 rounded-2xl hover:bg-gray-50">
                <div class="flex-shrink-0 w-10 h-10 flex items-center justify-center bg-violet-100 rounded-full">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-violet-600">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
                  </svg>
                </div>
                <div class="min-w-0">
                  <div class="text-xs uppercase tracking-wide text-gray-500"><%= label %></div>
                  <div class="text-gray-800 whitespace-pre-line"><%= value %></div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>

    </div>
  </section>
</div>
