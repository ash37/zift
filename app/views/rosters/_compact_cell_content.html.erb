<%
  # Load shifts like main view
  if defined?(@shifts_by_user_and_date) && @shifts_by_user_and_date
    shifts = (@shifts_by_user_and_date[[user.id, date]] || [])
  else
    shifts = roster.shifts.where(user: user, start_time: date.all_day)
  end
  if selected_location_id.present?
    shifts = shifts.select { |s| s.location_id.to_s == selected_location_id.to_s }
  end
  shifts = shifts.sort_by(&:start_time)
  count_for_day = shifts.size
%>

<div id="<%= dom_id(roster, "cell_content_#{user.id}_#{date}") %>"
     class="shifts-container relative w-45 h-9 rounded-2xl p-0"
     data-controller="drag"
     data-drag-enabled-value="<%= roster.draft? %>"
     data-drag-url-value="/shifts/:id"
     data-drag-user-id-value="<%= user.id %>"
     data-drag-date-value="<%= date.to_s %>"
     data-drag-roster-id-value="<%= roster.id %>">

  <% if shifts.any? %>
    <%# Stack pills directly on top of each other (no offset). Top pill shows aggregated range when multiple. %>
    <% if count_for_day > 1 %>
      <% first_shift = shifts.first %>
      <% last_shift  = shifts.last %>
      <% fst = first_shift.start_time.in_time_zone %>
      <% let = last_shift.end_time.in_time_zone %>
      <% start_label = fst.min.zero? ? fst.strftime('%-l') : fst.strftime('%-l:%M') %>
      <% end_label   = let.min.zero? ? let.strftime('%-l%P') : let.strftime('%-l:%M%P') %>
      <% aggregate_label = "#{start_label} - #{end_label}" %>
      <%# Render individual pills first so the aggregate (rendered last) sits on top visually %>
      <% shifts.drop(1).each do |shift| %>
        <%= render 'rosters/shift_pill', shift: shift, user: user, date: date, count_for_day: count_for_day, selected_location_id: selected_location_id, stacked: true %>
      <% end %>
      <%= render 'rosters/shift_pill', shift: first_shift, user: user, date: date, count_for_day: count_for_day, selected_location_id: selected_location_id, stacked: true, time_label: aggregate_label, group_ids: shifts.map(&:id).join(','), tooltip_shifts: shifts %>
    <% else %>
      <%= render 'rosters/shift_pill', shift: shifts.first, user: user, date: date, count_for_day: count_for_day, selected_location_id: selected_location_id, stacked: true, hover_controls: true %>
    <% end %>

    <%# Overlay count badge positioned like the hover drag icon (left ~2.5px). Hidden when only one shift %>
    <% if count_for_day > 1 %>
      <span class="ml-2 mt-4 pointer-events-none absolute left-[8px] top-1/2 -translate-y-1/2 translate-y-[2px] inline-flex items-center justify-center w-6 h-6 rounded-full bg-violet-500 text-white text-xs z-10">
        <%= count_for_day %>
      </span>
    <% end %>
  <% else %>
    <% if roster.draft? %>
      <%= link_to new_shift_path(user_id: user.id, roster_id: roster.id, date: date, location_id: selected_location_id),
                  data: { turbo_frame: 'assign_shift_modal' },
                  class: 'block w-full h-full text-center group',
                  aria_label: "Add shift for #{user.name} on #{date.strftime('%A, %B %d')}" do %>
        <div class="flex items-center justify-center w-full h-full relative">
          <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-white text-white text-xs translate-y-[1.5px]">
            +
          </span>
        </div>
      <% end %>
    <% end %>
  <% end %>
</div>
