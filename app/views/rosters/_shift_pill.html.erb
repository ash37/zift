<%# Renders a draggable shift as a compact pill. Must be wrapped in a turbo-frame with data-id for Sortable. %>
<% roster = shift.roster %>
<% wrapper_classes = local_assigns[:stacked] ? "absolute inset-0" : "inline-block" %>
<%
  data_attrs = { id: shift.id }
  data_attrs[:group_ids] = local_assigns[:group_ids] if local_assigns[:group_ids].present?
%>
<%= turbo_frame_tag dom_id(shift), data: data_attrs, target: "assign_shift_modal", class: wrapper_classes do %>
  <% has_tooltip = local_assigns[:tooltip_shifts].present? %>
  <div class="relative w-full h-full" <%= has_tooltip ? "x-data=\"{ open: false }\"".html_safe : "" %>>
  <button class="group relative flex items-center justify-center pl-10 pr-8 py-1.5 bg-violet-200 rounded-full hover:bg-violet-300 transition w-full h-9 box-border overflow-hidden"
          <%= has_tooltip ? "@click=\"open = !open\"".html_safe : "" %>
          <%= has_tooltip ? "aria-expanded=\"false\"".html_safe : "" %>>
    <!-- Centered time text -->
    <% provided_label = local_assigns[:time_label] %>
    <% if provided_label.present? %>
      <span class="mx-2 grow text-center font-semibold text-violet-700 text-sm truncate"><%= provided_label %></span>
    <% else %>
      <% st = shift.start_time.in_time_zone %>
      <% et = shift.end_time.in_time_zone %>
      <% start_label = st.min.zero? ? st.strftime('%-l') : st.strftime('%-l:%M') %>
      <% end_label = et.min.zero? ? et.strftime('%-l%P') : et.strftime('%-l:%M%P') %>
      <span class="mx-2 grow text-center font-semibold text-violet-700 text-sm truncate"><%= "#{start_label} - #{end_label}" %></span>
    <% end %>

    <%# Count badge moved to cell overlay layer; removed from pill %>

    <%# Hover controls for single-shift cells: drag handle, edit, add %>
    <% if local_assigns[:hover_controls] %>
      <div class="absolute inset-0 z-0 opacity-0 group-hover:opacity-100 transition flex items-center justify-between px-2 pointer-events-none group-hover:pointer-events-auto bg-violet-200 rounded-full">
        <!-- Left: drag handle (six dots) -->
        <span class="drag-handle flex items-center justify-center w-6 h-6 rounded-full bg-violet-500 text-white cursor-grab active:cursor-grabbing" title="Drag">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 36 36" class="w-6 h-6">
            <circle cx="15" cy="12" r="1.5"></circle>
            <circle cx="15" cy="18" r="1.5"></circle>
            <circle cx="15" cy="24" r="1.5"></circle>
            <circle cx="21" cy="12" r="1.5"></circle>
            <circle cx="21" cy="18" r="1.5"></circle>
            <circle cx="21" cy="24" r="1.5"></circle>
          </svg>
        </span>

        <!-- Middle: edit pencil -->
        <%= link_to edit_shift_path(shift, location_id: selected_location_id), data: { turbo_frame: 'assign_shift_modal' }, class: 'flex items-center justify-center w-6 h-6 rounded-full bg-violet-500 text-white' do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
          </svg>
        <% end %>

        <!-- Right: add new shift (plus) -->
        <% if roster.draft? %>
          <%= link_to new_shift_path(user_id: user.id, roster_id: roster.id, date: date, location_id: selected_location_id), data: { turbo_frame: 'assign_shift_modal' }, aria: { label: 'Add shift' }, class: 'flex items-center justify-center w-6 h-6 rounded-full bg-violet-500 text-white' do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          <% end %>
        <% else %>
          <span class="w-6 h-6"></span>
        <% end %>
      </div>
    <% end %>
  </button>
  <% if has_tooltip %>
    <div x-cloak x-show="open" x-transition @click.outside="open = false"
         class="absolute left-1/2 -translate-x-1/2 top-full mt-1 z-0 w-70 bg-white rounded-2xl p-4">
      <div class="text-xs text-gray-700 font-semibold mb-1">Shifts</div>
      <ul class="space-y-1">
        <% tooltip_shifts.each do |s| %>
          <% st = s.start_time.in_time_zone %>
          <% et = s.end_time.in_time_zone %>
          <% start_label = st.min.zero? ? st.strftime('%-l') : st.strftime('%-l:%M') %>
          <% end_label = et.min.zero? ? et.strftime('%-l%P') : et.strftime('%-l:%M%P') %>
          <li class="flex items-center justify-between text-xs text-gray-800">
            <span><%= start_label %> - <%= end_label %></span>
            <% if s.location_id.present? %>
              <span class="ml-2 text-[10px] text-gray-500">@ <%= Location.find_by(id: s.location_id)&.name %></span>
            <% end %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>
  </div>
<% end %>
