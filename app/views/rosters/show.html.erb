<h1 class="text-2xl font-bold mb-4">
  Roster: Week of <%= @roster.starts_on.strftime('%b %d, %Y') %>
</h1>

<p class="mb-4">
  Status:
  <span class="inline-block px-2 py-1 rounded text-white text-sm <%= @roster.draft? ? 'bg-yellow-500' : 'bg-green-600' %>">
    <%= @roster.status_label %>
  </span>
</p>

<% if @roster.draft? %>
  <div class="mb-6 flex gap-3">
    <%= button_to "Copy Previous Week", copy_previous_week_roster_path(@roster), method: :post, class: "bg-gray-200 hover:bg-gray-300 text-sm px-4 py-2 rounded-md" %>
    <%= button_to "Publish Roster", publish_roster_path(@roster), method: :post, class: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm" %>
  </div>
<% end %>

<table class="w-full border border-gray-300 text-sm">
  <thead>
    <tr>
      <th class="bg-gray-100 text-left p-2 border border-gray-300">Employee</th>
      <% 7.times do |i| %>
        <th class="bg-gray-100 text-center p-2 border border-gray-300">
          <%= (@roster.starts_on + i.days).strftime("%a %d") %>
        </th>
      <% end %>
    </tr>
  </thead>

  <tbody>
    <% User.all.each do |user| %>
      <tr>
        <td class="font-medium p-2 border border-gray-300"><%= user.name %></td>
        <% 7.times do |i| %>
          <% date = @roster.starts_on + i.days %>
          <%# This cell is now a drop zone and a Stimulus controller host %>
          <td id="roster_day_<%= user.id %>_<%= date %>"
              class="align-top p-2 border border-gray-300 hover:bg-gray-50 group relative min-h-[60px]"
              data-controller="drag"
              data-user-id="<%= user.id %>"
              data-date="<%= date %>">

            <% shifts = Shift.where(roster: @roster, user: user).where("DATE(start_time) = ?", date) %>

            <%# We now render the partial for each shift to keep the code DRY %>
           <%# If shifts exist in this cell, render them %>
<% if shifts.any? %>
  <% shifts.each do |shift| %>
    <%= render "shifts/shift", shift: shift %>
  <% end %>

<%# If the cell is empty %>
<% else %>
  <%# And the roster is a draft, make the entire cell a link to add a new shift %>
  <% if @roster.draft? %>
    <%= link_to new_shift_path(user_id: user.id, roster_id: @roster.id, date: date),
                data: { turbo_frame: "assign_shift_modal" },
                class: "block w-full h-full py-4 text-center group",
                aria_label: "Add shift for #{user.name} on #{date.strftime('%A, %B %d')}" do %>
      <%# This plus icon will scale up when the user hovers anywhere in the cell %>
      <span class="inline-block text-gray-400 transition-transform duration-200 group-hover:text-blue-600 group-hover:scale-125">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
      </span>
    <% end %>
  <% else %>
    <%# If not a draft, render an invisible character to maintain cell height %>
    <span class="invisible select-none">â€”</span>
  <% end %>
<% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<%# This frame will be used to load the 'new shift' modal %>
<turbo-frame id="assign_shift_modal"></turbo-frame>