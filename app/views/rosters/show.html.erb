<%= render "sub_nav", selected_location_id: @selected_location_id %>

<%# We add a style block here to define the custom styles for drag-and-drop. %>
<style>
  /* Style for the placeholder that appears in the new list */
  .sortable-ghost-custom {
    @apply bg-violet-100/50 border-2 border-dashed border-violet-400 rounded-lg;
  }
  .sortable-ghost-custom > * {
    @apply opacity-0;
  }

  /* Style for the item being dragged to give it a "lifted" effect */
  .sortable-drag-custom {
    @apply opacity-90 shadow-2xl scale-105;
  }

  /* Style for all potential drop zones when a drag is active */
  .drop-target-active {
    @apply bg-zinc-100 rounded-lg;
  }
</style>

<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 px-4 sm:px-0">
  <div>
    <h1 class="text-2xl font-bold text-gray-800">Roster for <%= @roster.starts_on.strftime('%B %d, %Y') %></h1>
    <p class="text-gray-500">
      <% if @roster.draft? %>
        <span class="text-yellow-500 font-semibold">Draft</span>
      <% else %>
        <span class="text-green-500 font-semibold">Published</span>
      <% end %>
    </p>
  </div>

  <div class="mt-4 sm:mt-0 flex items-center gap-x-2">
    <% if @roster.draft? %>
      <div x-data="{ open: false }">
        <button @click="open = true" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
          Publish
        </button>
      
        <div x-show="open" x-cloak @click.away="open = false" class="fixed z-10 inset-0 overflow-y-auto" style="display: none;">
          <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 z-0"></div>
            <div class="relative z-10 bg-white rounded-lg overflow-hidden shadow-xl transform transition-all sm:max-w-lg sm:w-full">
              <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                  Publish Roster
                </h3>
                <p class="text-sm text-gray-500 mt-2">
                  Would you like to notify all users of their shifts for this week?
                </p>
              </div>
              <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <%= button_to "Publish and Email", publish_with_email_roster_path(@roster), method: :post, class: "w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700" %>
                <%= button_to "Publish Only", publish_roster_path(@roster), method: :post, class: "mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3" %>
              </div>
            </div>
          </div>
        </div>
      </div>
      <%= button_to "Copy Previous Week", copy_previous_week_roster_path(@roster), method: :post, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" %>
    <% else %>
      <%= button_to "Revert to Draft", revert_to_draft_roster_path(@roster), method: :post, class: "px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600" %>
    <% end %>
  </div>
</div>

<div class="bg-zinc-100 p-4 sm:p-6 rounded-lg">
  <%# Calendar Table %>
  <table class="w-full border-separate table-fixed" style="border-spacing: 0;">
    <thead>
      <tr>
        <th class="w-48 text-left font-semibold p-2">EMPLOYEE</th>
        <% 7.times do |i| %>
          <% date = @roster.starts_on + i.days %>
          <th class="text-center font-normal p-2">
            <p class="text-xs text-zinc-500"><%= date.strftime("%a").upcase %></p>
            <p class="text-lg font-bold <%= date == Date.today ? 'text-violet-600' : 'text-zinc-800' %>">
              <%= date.strftime("%d") %>
            </p>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% User.all.each do |user| %>
        <tr class="align-top">
          <td class="p-2 border-t border-zinc-200">
            <div class="font-semibold text-zinc-800"><%= user.name %></div>
            <div id="<%= dom_id(user, 'hours_total') %>">
              <%= render 'rosters/user_hours', roster: @roster, user: user, selected_location_id: @selected_location_id %>
            </div>
          </td>
          <% 7.times do |i| %>
            <% date = @roster.starts_on + i.days %>
            <td class="p-1 border-t border-zinc-200">
              <%= render 'rosters/cell_content', roster: @roster, user: user, date: date, selected_location_id: @selected_location_id %>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
    <%# This new table footer will display the daily total hours. %>
    <tfoot>
      <tr class="text-center">
        <td class="p-2 border-t-2 border-zinc-300 text-left text-sm font-semibold text-zinc-800">TOTALS</td>
        <% 7.times do |i| %>
          <% date = @roster.starts_on + i.days %>
          <td class="p-2 border-t-2 border-zinc-300">
            <%= render 'rosters/daily_hours', roster: @roster, date: date, selected_location_id: @selected_location_id %>
          </td>
        <% end %>
      </tr>
    </tfoot>
  </table>
</div>

<%# This frame will be used to load the 'new shift' modal %>
<turbo-frame id="assign_shift_modal"></turbo-frame>