<%
  # Find any shifts for this user on this date
  shifts = roster.shifts.where(user: user, start_time: date.all_day)
  if selected_location_id.present?
    shifts = shifts.where(location_id: selected_location_id)
  end

  repeating_weekday_match = false

  # FIX: Check for an approved unavailability request that overlaps with this day,
  # and if none, look for a weekly repeating request for the same weekday
  approved_unavailability = user.unavailability_requests
                                .where(status: UnavailabilityRequest::STATUSES[:approved])
                                .where("starts_at <= ? AND ends_at >= ?", date.end_of_day, date.beginning_of_day)
                                .first

  if approved_unavailability.nil?
    repeating_candidates = user.unavailability_requests
                               .where(status: UnavailabilityRequest::STATUSES[:approved])
                               .where(repeats_weekly: true)

    match = repeating_candidates.detect { |req| req.starts_at.wday == date.wday }
    if match
      approved_unavailability = match
      repeating_weekday_match = true
    end
  end
%>
<div id="<%= dom_id(roster, "cell_content_#{user.id}_#{date}") %>" class="shifts-container h-full min-h-[80px]"
      data-controller="drag"
      data-drag-enabled-value="<%= roster.draft? %>"
      data-drag-url-value="/shifts/:id"
      data-drag-user-id-value="<%= user.id %>"
      data-drag-date-value="<%= date.to_s %>">

  <%# FIX: Add conditional rendering based on the unavailability check %>
  <% if approved_unavailability %>
    <div class="relative w-full border-2 p-3 rounded-2xl bg-orange-100 text-orange-500 opacity-50 text-xs flex flex-col justify-center text-center space-y-1">
      <% if repeating_weekday_match %>
        <span class="absolute top-1 right-1 text-orange-400" title="Repeats weekly">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12c0-1.232-.046-2.453-.138-3.662a4.006 4.006 0 0 0-3.7-3.7 48.678 48.678 0 0 0-7.324 0 4.006 4.006 0 0 0-3.7 3.7c-.017.22-.032.441-.046.662M19.5 12l3-3m-3 3-3-3m-12 3c0 1.232.046 2.453.138 3.662a4.006 4.006 0 0 0 3.7 3.7 48.656 48.656 0 0 0 7.324 0 4.006 4.006 0 0 0 3.7-3.7c.017-.22.032-.441.046-.662M4.5 12l3 3m-3-3-3 3" />
          </svg>
        </span>
      <% end %>
      <p class="font-semibold">UNAVAILABLE</p>
      <p>
        <% unless approved_unavailability.starts_at == approved_unavailability.starts_at.beginning_of_day %>
          <%= format_shift_time(approved_unavailability.starts_at) %> - <%= format_shift_time(approved_unavailability.ends_at) %>
        <% else %>
          All Day
        <% end %>
      </p>
      <p><%= approved_unavailability.reason %></p>
    </div>
  <% else %>
    <%# --- This is the original logic for when the user IS available --- %>
    <% if shifts.any? %>
      <% shifts.each do |shift| %>
        <%= render "shifts/shift", shift: shift, selected_location_id: selected_location_id %>
      <% end %>
    <% else %>
      <% if roster.draft? %>
        <%= link_to new_shift_path(user_id: user.id, roster_id: roster.id, date: date, location_id: selected_location_id),
                    data: { turbo_frame: "assign_shift_modal" },
                    class: "block w-full h-full text-center group",
                    aria_label: "Add shift for #{user.name} on #{date.strftime('%A, %B %d')}" do %>
          <div class="flex items-center justify-center h-full">
            <span class="mt-8 inline-block text-zinc-300 transition-transform duration-200 group-hover:text-violet-500 group-hover:scale-125">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
              </svg>
            </span>
          </div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>