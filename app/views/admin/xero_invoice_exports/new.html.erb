<div class="container mx-auto mt-10 px-4 py-10">
  <h1 class="text-3xl font-bold mb-6">Export Invoices to Xero</h1>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <%= form_with url: new_admin_xero_invoice_export_path, method: :get, local: true do %>
      <div class="flex flex-wrap gap-4 items-end mb-4">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700">Start date</label>
          <input type="date" name="start_date" id="start_date"
            value="<%= @start_date&.strftime('%Y-%m-%d') %>"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700">End date</label>
          <input type="date" name="end_date" id="end_date"
            value="<%= @end_date&.strftime('%Y-%m-%d') %>"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded">Update</button>
        </div>
      </div>
    <% end %>

    <p class="mb-6 text-gray-600">Review the invoice lines below before sending to Xero. Only approved timesheets for shifts with an assigned area will be included.</p>

    <% if @invoice_groups.present? %>
      <%= form_with(url: admin_xero_invoice_exports_path, method: :post) do |form| %>
        <%= hidden_field_tag :start_date, @start_date %>
        <%= hidden_field_tag :end_date, @end_date %>

        <div class="space-y-8">
          <% @invoice_groups.each do |group| %>
            <div class="border border-gray-200 rounded-lg p-4">
              <h3 class="text-lg font-semibold text-gray-800">To: <%= group.location.name %></h3>
              <table class="min-w-full divide-y divide-gray-200 mt-4">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Code</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <%# THE FIX IS HERE: Changed group.lines to group.timesheets and updated the loop variable %>
                  <% group.timesheets.each do |timesheet| %>
                    <tr>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><%= timesheet.shift.area.export_code %></td>
                      <td class="px-6 py-4 whitespace-pre-wrap text-sm text-gray-500">One Staff on <%= timesheet.clock_in_at.strftime('%a %d %b %Y') %> from <%= timesheet.clock_in_at.strftime('%-l:%M%P') %> - <%= timesheet.clock_out_at.strftime('%-l:%M%P') %></td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= number_with_precision(timesheet.duration_in_hours, precision: 2) %></td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">(from Xero)</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">(from Xero)</td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% end %>
        </div>

        <div class="mt-8 flex items-center space-x-4">
          <%= form.submit "Send to Xero", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" %>
          <%= link_to "Cancel", admin_xero_connection_path, class: "text-gray-600 hover:text-gray-800" %>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-500">No approved timesheets with billable areas were found for this period.</p>
    <% end %>
  </div>
</div>