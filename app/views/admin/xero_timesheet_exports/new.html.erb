<div class="container mx-auto mt-10 px-4 py-10">
  <h1 class="text-3xl font-bold mb-6">Export Payroll to Xero</h1>

  <div class="bg-white p-6 rounded-lg shadow-md">
    <% start_str = @pay_period_start&.strftime('%d %b %Y') %>
    <% end_str   = @pay_period_end&.strftime('%d %b %Y') %>

    <%= form_with url: new_admin_xero_timesheet_export_path, method: :get, local: true do %>
      <div class="flex flex-wrap gap-4 items-end mb-4">
        <div>
          <label for="start_date" class="block text-sm font-medium text-gray-700">Start date</label>
          <input type="date" name="start_date" id="start_date"
            value="<%= @pay_period_start&.strftime('%Y-%m-%d') %>"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <label for="end_date" class="block text-sm font-medium text-gray-700">End date</label>
          <input type="date" name="end_date" id="end_date"
            value="<%= @pay_period_end&.strftime('%Y-%m-%d') %>"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" />
        </div>
        <div>
          <button type="submit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-3 rounded">Update</button>
        </div>
      </div>
    <% end %>
    <div class="text-xs text-gray-500 mb-4">Override the detected pay period to review a custom date range.</div>

    <% if @payroll_calendar.nil? %>
      <p class="mb-4 text-amber-800 bg-amber-50 border border-amber-200 rounded px-3 py-2">
        We couldn’t fetch a Payroll Calendar from Xero right now. Using the current Wed–Tue week as a fallback. You can set custom dates above.
      </p>
    <% end %>

    <h2 class="text-xl font-semibold mb-2 text-gray-800">
      Pay Period: <%= start_str || '—' %> - <%= end_str || '—' %>
    </h2>

    <% if flash.now[:warning].present? %>
      <p class="mb-4 text-amber-800 bg-amber-50 border border-amber-200 rounded px-3 py-2"><%= flash.now[:warning] %></p>
    <% end %>

    <p class="mb-6 text-gray-600">Review the hours below before sending to Xero. Only approved timesheets for users linked to a Xero employee will be included.</p>

    <% if @user_hours.present? && @user_hours.any? %>
      <table class="min-w-full divide-y divide-gray-200 mb-6">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Hours</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @user_hours.each do |data| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"><%= data[:user].name %></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= number_with_precision(data[:total_hours], precision: 2) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>

      <%= form_with(url: admin_xero_timesheet_exports_path, method: :post) do |form| %>
        <%# **THE FIX IS HERE**: Added the hidden fields to send the dates with the form %>
        <%= hidden_field_tag :pay_period_start, @pay_period_start %>
        <%= hidden_field_tag :pay_period_end, @pay_period_end %>
        
        <div class="flex items-center space-x-4">
          <%= form.submit "Send to Xero", class: "bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded" %>
          <%= link_to "Cancel", admin_xero_connection_path, class: "text-gray-600 hover:text-gray-800" %>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-500">No timesheets found for linked employees in this pay period.</p>
    <% end %>
  </div>
</div>